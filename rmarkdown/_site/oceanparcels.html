<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="George Roff" />

<meta name="date" content="2024-08-20" />

<title>Ocean Parcels central GBR</title>

<script src="site_libs/header-attrs-2.28/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/spacelab.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="empty.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Spatial Tools</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-cube"></span>
     
    Introduction
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-layer-group"></span>
     
    Shiny examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Simple Spatial Tools</li>
    <li>
      <a href="https://marine-ecologist.shinyapps.io/rotate-polygons/">  a) rotate polygons</a>
    </li>
    <li>
      <a href="https://marine-ecologist.shinyapps.io/draw-plots/">  b) draw plots</a>
    </li>
    <li class="dropdown-header">Dynamic Raster classification</li>
    <li>
      <a href="https://marine-ecologist.shinyapps.io/classify-rasters/">  a) static rasters</a>
    </li>
    <li>
      <a href="https://marine-ecologist.shinyapps.io/classify-rasters-wms/">  b) dynamic rasters</a>
    </li>
    <li class="dropdown-header">Interactive tools</li>
    <li>
      <a href="https://marine-ecologist.shinyapps.io/Interactive-Ocean-Data/">  i) Visualise raster time-series</a>
    </li>
    <li>
      <a href="https://marine-ecologist.shinyapps.io/remove-zones/">  ii) Exclude map zones</a>
    </li>
    <li>
      <a href="https://marine-ecologist.shinyapps.io/spatial-decision-tool/">  iii) Dynamic spatial selection</a>
    </li>
  </ul>
</li>
<li>
  <a href="set-polygons.html">
    <span class="fa fa-rotate-left"></span>
     
    Site selection
  </a>
</li>
<li>
  <a href="https://github.com/marine-ecologist/spatial-tools/">
    <span class="fa fa-github"></span>
     
    GitHub
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Ocean Parcels central GBR</h1>
<h4 class="author">George Roff</h4>
<h4 class="date">2024-08-20</h4>

</div>


<div id="oceanparcels" class="section level3">
<h3>1. oceanparcels</h3>
<p>Reproducible code from Ani <em>et al</em> (2024) “<a
href="https://www.nature.com/articles/s41598-024-64388-8">Connectivity
modelling identifies sources and sinks of coral recruitment within reef
clusters</a>” <em>Scientific Reports</em> 13564</p>
<ul>
<li><p>Code updated to work with OceanParcels 3.0.4</p></li>
<li><p>GBR1 hydrodynamic data from 30/11/15 to 31/12/15</p></li>
<li><p>5 day run duration</p></li>
</ul>
<pre class="python fold-show"><code># -- coding utf-8 --
&quot;&quot;&quot;

Modified code from nestedfield_2d.py (via https://zenodo.org/doi/10.5281/zenodo.10638015)
Code works with Parcels 3.0.4 and uses with a subset of GBR1 hydrodynamic data for 2015 spawning
Preliminary, to be validated

&quot;&quot;&quot;

from parcels import Field, NestedField, FieldSet, ParticleSet, JITParticle, Variable, ParticleFile, StatusCode, AdvectionRK4
import numpy as np
import datetime
from datetime import datetime
import pandas as pd
from datetime import timedelta as delta
import netCDF4
from glob import glob
import argparse
import os
os.environ[&#39;USE_PYGEOS&#39;] = &#39;0&#39;
import geopandas as gpd
from shapely.geometry import Point

# Initialize the argument parser
parser = argparse.ArgumentParser()

# Define the expected arguments
parser.add_argument(&#39;cluster&#39;, type=str, help=&#39;Cluster identifier&#39;)  
parser.add_argument(&#39;year&#39;, type=str, help=&#39;Year of the release&#39;)
parser.add_argument(&#39;day&#39;, type=str, help=&#39;Day of the release&#39;)
parser.add_argument(&#39;spatial_data&#39;, type=str, help=&#39;Path to spatial data&#39;)

# Parse the arguments
args = parser.parse_args()

cluster=&#39;Moore&#39;
num_release = 181      #total release time in minutes
int_release = 20        #time interval of particle release in minutes
num_particles = 10     #total number of released particles per site 
run_duration = 1      #duration of model run in days
out_dt = 1          #output timestep in hours
run_dt = 10             #run timestep in minutes
depth0 = -2.25         #depth at which particles are released

#create GBR1 fieldset
data_path = &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/&#39;


# File paths
files = [
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-11-30.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-01.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-03.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-04.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-05.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-06.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-07.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-08.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-09.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-10.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-11.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-12.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-13.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-14.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-15.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-16.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-17.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-18.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-19.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-20.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-21.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-22.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-23.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-24.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-25.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-26.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-27.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-28.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-29.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-30.nc&#39;,
    &#39;/Users/rof011/Downloads/GBR_connectivity/Oceanparcels/Moore_uv_2015-12-31.nc&#39;,
]

filenames = {&#39;U&#39;: {&#39;lon&#39;: files[0], &#39;lat&#39;: files[0], &#39;depth&#39;: files[0], &#39;data&#39;: files},
             &#39;V&#39;: {&#39;lon&#39;: files[0], &#39;lat&#39;: files[0], &#39;depth&#39;: files[0], &#39;data&#39;: files}}
variables = {&#39;U&#39;: &#39;u&#39;,
             &#39;V&#39;: &#39;v&#39;}
dimensions = {&#39;U&#39;: {&#39;lon&#39;: &#39;longitude&#39;, &#39;lat&#39;: &#39;latitude&#39;, &#39;depth&#39;: &#39;zc&#39;, &#39;time&#39;: &#39;time&#39;},
              &#39;V&#39;: {&#39;lon&#39;: &#39;longitude&#39;, &#39;lat&#39;: &#39;latitude&#39;, &#39;depth&#39;: &#39;zc&#39;, &#39;time&#39;: &#39;time&#39;}}

fieldset = FieldSet.from_netcdf(filenames, variables, dimensions, chunksize = &#39;auto&#39;, allow_time_extrapolation = True)

#create RECOM fieldset
data = &#39;/Users/rof011/Downloads/GBR_connectivity/datafiles/Moore_2015_simple.nc&#39;

dimensionsU={&#39;lon&#39;:&#39;longitude&#39;, &#39;lat&#39;:&#39;latitude&#39;, &#39;depth&#39;: &#39;zc&#39;, &#39;time&#39;:&#39;time&#39;}
dimensionsV={&#39;lon&#39;:&#39;longitude&#39;, &#39;lat&#39;:&#39;latitude&#39;, &#39;depth&#39;: &#39;zc&#39;, &#39;time&#39;:&#39;time&#39;}
U_recom=Field.from_netcdf(data, (&#39;U_recom&#39;,&#39;u&#39;), dimensionsU, fieldtype=&#39;U&#39;, chunksize = &#39;auto&#39;, allow_time_extrapolation = True)
V_recom=Field.from_netcdf(data, (&#39;V_recom&#39;,&#39;v&#39;), dimensionsV, fieldtype=&#39;V&#39;, chunksize = &#39;auto&#39;, allow_time_extrapolation = True)


#add RECOM fieldset to GBR fieldset
fieldset.add_field(U_recom)
fieldset.add_field(V_recom)

#create nested field
U=NestedField(&#39;U&#39;, [fieldset.U_recom, fieldset.U])
V=NestedField(&#39;V&#39;, [fieldset.V_recom, fieldset.V])
nest=FieldSet(U, V)

f = netCDF4.Dataset(data) #extract RECOM coordinates
lat = f.variables[&#39;latitude&#39;]
lon = f.variables[&#39;longitude&#39;]
latvals = lat[:]; lonvals = lon[:]


# a function to find the index of the point closest
# (in squared distance) to a given latlon value.
def getclosest_ij(lats,lons,latpt,lonpt):
  # find squared distance of every point on grid
  dist_sq = (lats-latpt)**2 + (lons-lonpt)**2
  # 1D index of minimum dist_sq element
  minindex_flattened = dist_sq.argmin()
  # Get 2D index for latvals and lonvals arrays from 1D index
  return np.unravel_index(minindex_flattened, lats.shape)


#read geospatial data 
coord = gpd.read_file(&#39;/Users/rof011/Downloads/GBR_connectivity/datafiles/MooreCluster_SpatialPolygons.gpkg&#39;)
np.random.seed(10)

#a function to get random points in a polygon
def random_point_in_poly(poly):
        within = False
        while not within:
            x = np.random.uniform(poly.bounds[0], poly.bounds[2])
            y = np.random.uniform(poly.bounds[1], poly.bounds[3])
            within = poly.contains(Point(x, y))
        return Point(x,y)

Lat, Lon = [], []
for i in range(num_particles):
    coord[&#39;Point&#39; + str(i)] = coord[&#39;geometry&#39;].apply(random_point_in_poly)
    Lat = [*Lat,*list(coord[&#39;Point&#39;+str(i)].y)]
    Lon = [*Lon,*list(coord[&#39;Point&#39;+str(i)].x)]

releases = {
    2015: {
        1: datetime(2015, 11, 30, 20, 0),
        2: datetime(2015, 12, 1, 20, 0),
        3: datetime(2015, 12, 2, 20, 0)
    }
}

t0 = releases[2015][1]
res = [t0 + delta(minutes=idx) for idx in range(0,num_release,int_release)] 
release_time = [i for i in res for n in range(0,len(coord))]  #list containing the initial conditions of all released particles
depth = [depth0] * len(Lat)

#create a particle set with the nested field
pset = ParticleSet.from_list(nest, pclass=JITParticle,
                             lon = Lon,
                             lat = Lat,
                             depth = depth,
                             time = release_time)
for p in pset:
    yi, xi = getclosest_ij(latvals, lonvals, p.lat, p.lon)
    p.xi = np.array([xi], dtype=np.int32)
    p.yi = np.array([yi], dtype=np.int32)
    
def DeleteParticle(particle, fieldset, time):   #delete particles that are out of bounds
    particle.delete() 

# Define the CheckOutOfBounds function for particles that go out of bounds
def CheckOutOfBounds(particle, fieldset, time):
    if particle.state == StatusCode.ErrorOutOfBounds:
        particle.delete()
    
    
kernels = pset.Kernel(AdvectionRK4) + pset.Kernel(CheckOutOfBounds)


# Use the error handling function during execution
output_file = pset.ParticleFile(name=f&#39;{args.cluster}outputs{args.year}{args.cluster}_trajectory_{args.year}_d{args.day}2d.zarr&#39;, 
                                outputdt=delta(hours=out_dt))

pset.execute(kernels, runtime=delta(days=run_duration), dt=delta(minutes=run_dt), 
             output_file=output_file) 

output_file.close()</code></pre>
<p>additional code to export zarr to .csv
(<code>python_xarray_convert.py</code>)</p>
<pre class="python fold-show"><code>import xarray as xr
import pandas as pd

zarr_path = &#39;/Users/rof011/Mooreoutputs2015Moore_trajectory_2015_d12d.zarr_mon20th.zarr/&#39;
zarr_path = &#39;/Users/rof011/oceanparcels_seeding/&#39;

ds = xr.open_zarr(zarr_path)

df = ds.to_dataframe().reset_index()

df_filtered = df[[&#39;obs&#39;, &#39;trajectory&#39;, &#39;lon&#39;, &#39;lat&#39;, &#39;time&#39;]]

df_filtered.to_csv(&#39;oceanparcels_seeding.csv&#39;, index=False)</code></pre>
</div>
<div id="particle-tracks" class="section level3">
<h3>2. Particle tracks</h3>
<p>Import particle tracks and points</p>
<pre class="r"><code>library(tidyverse)
library(sf)
library(tmap)</code></pre>
<p>[slight <code>sf</code> hack to create <code>linestrings</code> from
<code>points</code> to get particle trajectories, create minimally valid
<code>linestring</code> by duplicating point if <code>npoints</code>
&lt; 2]</p>
<pre class="r"><code>moore_habitats &lt;- read_sf(&quot;/Users/rof011/spatialtools/data/MooreCluster_SpatialPolygons.gpkg&quot;, quiet=TRUE)


ocean_parcels_particles &lt;- read.csv(&quot;/Users/rof011/spatialtools/data/trajectories_obs_data.csv&quot;) |&gt;
  drop_na(lon, lat) |&gt;
  st_as_sf(coords=c(&quot;lon&quot;, &quot;lat&quot;)) |&gt;
  st_set_crs(4326) |&gt;
  st_transform(20353) |&gt;
  mutate(time=ymd_hms(time)) |&gt;  
  mutate(day=day(time)) 

ocean_parcels_particles &lt;- ocean_parcels_particles |&gt;
  mutate(nday = ifelse(day==30, 0, day)+1) |&gt; 
  mutate(trajectory=as.numeric(trajectory), nday=as.numeric(nday)) |&gt; 
  st_make_valid() %&gt;%
  arrange(trajectory, nday, time)


add_next_nday_point &lt;- function(data) {
  max_nday &lt;- max(data$nday)  # Identify the maximum `nday` for the trajectory
  
  data %&gt;%
    group_by(nday) %&gt;%
    summarise(
      geometry = {
        current_nday &lt;- unique(nday)  # Get the unique value of `nday` in this group
        
        combined_geom &lt;- st_combine(geometry)
        
        if(current_nday &lt; max_nday) {
          next_point &lt;- data %&gt;%
            filter(nday == current_nday + 1) %&gt;%
            slice(1) %&gt;%
            pull(geometry)
          combined_geom &lt;- st_combine(c(combined_geom, next_point))
        }
        
        st_cast(combined_geom, &quot;LINESTRING&quot;)
      },
      .groups = &quot;drop&quot;
    )
}

# Apply the function to each trajectory and combine results
ocean_parcels_lines_tmp &lt;- ocean_parcels_particles %&gt;%
  group_by(trajectory) %&gt;%
  group_modify(~ add_next_nday_point(.x)) %&gt;%
  ungroup() %&gt;%
  st_as_sf()


# Function to ensure a LINESTRING has at least two points by duplicating the last point if necessary
ensure_two_points &lt;- function(geometry) {
  coords &lt;- st_coordinates(geometry)
  if (nrow(coords) &lt; 2) {
    coords &lt;- rbind(coords, coords)  
  }
  st_linestring(coords)
}


ocean_parcels_lines &lt;- ocean_parcels_lines_tmp %&gt;%
  dplyr::mutate(geometry = purrr::map(geometry, ensure_two_points)) %&gt;%  # Use purrr::map to retain the list-column structure
  dplyr::mutate(geometry = st_zm(geometry)) %&gt;%  # Drop the Z axis
  st_sf() |&gt; 
  st_set_crs(20353) # Recreate the crs</code></pre>
<p>Visualise ~200 subset tracks across the 5 days</p>
<pre class="r"><code>library(stars)
set.seed=1

# set recom grid
nc_data &lt;- stars::read_ncdf(&quot;/Users/rof011/GBR_connectivity/datafiles/Moore_2015_simple.nc&quot;) |&gt; 
  st_as_stars()

lat_dims &lt;- nc_data |&gt; st_as_stars() |&gt; st_get_dimension_values(2) |&gt; as.data.frame() |&gt; t() |&gt; as.data.frame() |&gt; slice(1) |&gt; as.numeric()
lon_dims &lt;- nc_data |&gt; st_as_stars() |&gt; st_get_dimension_values(1) |&gt; as.data.frame() |&gt; slice(1) |&gt; as.numeric()

lat_range &lt;- range(lat_dims)
lon_range &lt;- range(lon_dims)
bbox &lt;- st_bbox(c(xmin = lon_range[1], ymin = lat_range[1], xmax = lon_range[2], ymax = lat_range[2]), crs = st_crs(4326))
cellsize &lt;- c(diff(lon_range) / (length(lon_dims) - 1), diff(lat_range) / (length(lat_dims) - 1))
grid_sf &lt;- st_make_grid(st_as_sfc(bbox), cellsize = cellsize, square = TRUE) |&gt; st_transform(20353) |&gt; st_sf()



#subset ~200 random tracks

subset_particles &lt;- ocean_parcels_particles %&gt;%
  dplyr::filter(trajectory %in% seq(1,nrow(ocean_parcels_lines),round(nrow(ocean_parcels_lines)/200))) |&gt; 
  arrange(trajectory,nday) 


# Filter the tracks based on trajectory and then ensure valid LINESTRING geometries
subset_tracks &lt;- ocean_parcels_lines %&gt;%
  dplyr::filter(trajectory %in% seq(1, nrow(ocean_parcels_lines), round(nrow(ocean_parcels_lines) / 200))) 

tmap_mode(&quot;plot&quot;) +
tm_basemap(&quot;Esri.WorldImagery&quot;) +
tm_shape(moore_habitats) +
  tm_polygons(fill=&quot;habitat&quot;,
              lwd=0,
              fill.legend = tm_legend_hide(),
              fill.scale=tm_scale_categorical(values=&quot;brewer.pastel1&quot;),
              fill.alpha=0.2) +
tm_shape(subset_tracks, is.main=TRUE) +
  tm_lines(col=&quot;nday&quot;,
           lwd=4,
           popup.vars=c(&quot;trajectory&quot;, &quot;nday&quot;),
           col.scale=tm_scale_continuous(values=&quot;-rd_yl_bu&quot;)) +
tm_shape(subset_particles) +
  tm_lines(col=&quot;nday&quot;,
           lwd=0,
           popup.vars=c(&quot;trajectory&quot;, &quot;nday&quot;),
           size=0.2,
           col.scale=tm_scale_continuous(values=&quot;-rd_yl_bu&quot;)) #+</code></pre>
<p><img src="oceanparcels_files/figure-html/unnamed-chunk-5-1.png" width="912" /></p>
<pre class="r"><code>#tm_shape(sf_grid) +
#  tm_polygons(col=&quot;red&quot;)</code></pre>
<p>Compare two contrasting particle tracks:</p>
<pre class="r"><code># subset two particles &amp; tracks
p1_particles &lt;- ocean_parcels_particles |&gt; filter(trajectory %in% c(1))
p100_particles &lt;- ocean_parcels_particles |&gt; filter(trajectory %in% c(100))

p1_tracks &lt;- ocean_parcels_lines |&gt; filter(trajectory %in% c(1))
p100_tracks &lt;- ocean_parcels_lines |&gt; filter(trajectory %in% c(100))



particle_1 &lt;- tm_basemap(&quot;Esri.WorldImagery&quot;) +
tm_shape(p1_particles) +
  tm_dots(fill=&quot;nday&quot;,
          size=0.05,
          fill.legend = tm_legend_hide(),
          fill.scale=tm_scale_continuous(values=&quot;-rd_yl_bu&quot;)) +
tm_shape(p1_tracks) +
  tm_lines(col=&quot;nday&quot;, 
           lwd=4,
           col.legend = tm_legend_hide(),
           col.scale=tm_scale_continuous(values=&quot;-rd_yl_bu&quot;)) +
tm_options(set.view=c(146.24, -16.9, 1))


particle_100 &lt;- tm_basemap(&quot;Esri.WorldImagery&quot;) +
tm_shape(p100_particles) +
  tm_dots(fill=&quot;nday&quot;,
          size=0.05,
          fill.scale=tm_scale_continuous(values=&quot;-rd_yl_bu&quot;)) +
tm_shape(p100_tracks) +
  tm_lines(col=&quot;nday&quot;, 
           lwd=4,
           col.legend = tm_legend_hide(),
           col.scale=tm_scale_continuous(values=&quot;-rd_yl_bu&quot;))  +
tm_options(set.view=c(146.24, -16.9, 11))

tmap_arrange(particle_1, particle_100, ncol=2, sync=TRUE)</code></pre>
<pre><code>## Tiles from Esri.WorldImagery will be projected so details (e.g. text) could appear blurry
## Tiles from Esri.WorldImagery will be projected so details (e.g. text) could appear blurry</code></pre>
<p><img src="oceanparcels_files/figure-html/unnamed-chunk-6-1.png" width="912" /></p>
<p>Calculate track lengths</p>
<pre class="r"><code>ocean_parcels_lines &lt;- ocean_parcels_lines %&gt;%
  mutate(length_m = st_length(geometry)) 

ocean_parcels_movement &lt;- ocean_parcels_lines |&gt; 
  mutate(beach = ifelse(length_m &lt; units::set_units(10,&quot;m&quot;), &quot;beach&quot;, &quot;dispersed&quot;))</code></pre>
<p>View the total distances per particle per day (500m distance
bins):</p>
<pre class="r"><code>ocean_parcels_movement_m &lt;- ocean_parcels_movement |&gt; 
  as.data.frame() |&gt; 
  mutate(length_m = as.numeric(length_m)) |&gt; 
  mutate(length_bin = cut(length_m, 
                          breaks = seq(0, max(length_m, na.rm = TRUE) + 500, by = 500), 
                          include.lowest = TRUE, 
                          right = FALSE, 
                          labels = FALSE)) |&gt; 
   mutate(length_bin = (length_bin *500) - 250)
        

ocean_parcels_movement_binn &lt;- ocean_parcels_movement_m |&gt; 
  group_by(length_bin) |&gt; 
  summarise(count=n()) |&gt; 
  mutate(proportion=count/nrow(ocean_parcels_movement_m) *100)

ggplot() + theme_bw() + 
  geom_col(data=ocean_parcels_movement_binn, aes(x=length_bin, y=proportion, fill=as.numeric(length_bin)), 
           color=&quot;black&quot;,  linewidth=0.25, show.legend=FALSE) +
  scale_fill_distiller(palette = &quot;RdBu&quot;, direction = 1) +
  xlab(&quot;\n distance travelled per day (metres)&quot;) +
  ylab(&quot;% particles&quot;)</code></pre>
<p><img src="oceanparcels_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>Some particles are moving &lt;500m, so:</p>
<ul>
<li>create a “beached” category where movement is &lt;10 metres in 1
day</li>
<li>for each particle, calculate distance per day</li>
<li>if &lt;10m, classify “beached”, if &gt;10m, classify
“dispersed”</li>
</ul>
<p>Calculate the proportion of days where the entire day is “beached”
(i.e. &lt;10m distance movement):</p>
<pre class="r"><code>beached_summary &lt;- ocean_parcels_movement %&gt;%
  as.data.frame() %&gt;%
  group_by(trajectory) %&gt;%
  summarise(beached_count = sum(beach == &quot;beach&quot;), dispersed_count = sum(beach == &quot;dispersed&quot;)) |&gt; 
  group_by(trajectory) %&gt;%
  mutate(total_count=sum(beached_count) + sum(dispersed_count))


ggplot() + 
  theme_bw() + 
  geom_histogram(data = beached_summary, 
                 aes(x = beached_count, fill = as.factor(beached_count)), 
                 color = &quot;black&quot;, 
                 linewidth = 0.5, 
                 show.legend=FALSE,
                 binwidth = 1) +  # Set binwidth to 1 for discrete data
  scale_y_log10() + 
  scale_x_continuous(breaks = seq(1, 6, 1)) + 
  scale_fill_brewer(palette = &quot;Reds&quot;) + 
  xlab(&quot;\n number of days with &lt;10m movement per particle release&quot;) +
  
  # Add geom_text to display count labels above bars
  geom_text(data = beached_summary, 
            aes(x = beached_count, 
                y = ..count.., 
                label = ..count..), 
            stat = &quot;bin&quot;, 
            vjust = 2,  # Adjust the vertical position of the labels
            size = 3) +  # Adjust the size of the text
  xlab(&quot;\n number of days with &lt;10m movement per particle release&quot;)</code></pre>
<p><img src="oceanparcels_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Majority of particles show free dispersal, limited number (175
particles, ~5.5%) show beaching of 1-6 days</p>
<p>Isolate the particles &gt; 4 days and visualise:</p>
<pre class="r"><code>beached_summary_5more &lt;- beached_summary |&gt; filter(beached_count&gt;3)


# subset two particles &amp; tracks

beached_tracks &lt;- ocean_parcels_lines |&gt; group_by(trajectory) |&gt; dplyr::filter(trajectory %in% beached_summary_5more$trajectory)
beached_particles &lt;- ocean_parcels_particles |&gt; group_by(trajectory) |&gt; dplyr::filter(trajectory %in% beached_summary_5more$trajectory)



tm_basemap(&quot;Esri.WorldImagery&quot;) +
tm_shape(beached_tracks) +
  tm_lines(col=&quot;nday&quot;,
           lwd=5,
           popup.vars=c(&quot;trajectory&quot;, &quot;nday&quot;),
           col.legend = tm_legend(legend.text.size = 0.6, 
                                  legend.height=1.1, 
                                  item.height=1.1),
           col.scale=tm_scale_continuous(values=&quot;-rd_yl_bu&quot;)) #+</code></pre>
<pre><code>## Tiles from Esri.WorldImagery will be projected so details (e.g. text) could appear blurry</code></pre>
<p><img src="oceanparcels_files/figure-html/unnamed-chunk-10-1.png" width="912" /></p>
<pre class="r"><code># tm_shape(beached_particles) +
#   tm_dots(fill=&quot;nday&quot;, 
#            lwd=0,
#            popup.vars=c(&quot;trajectory&quot;, &quot;nday&quot;),
#            size=0.2,
#            fill.scale=tm_scale_categorical(values=&quot;-rd_yl_bu&quot;),
#            fill.legend = tm_legend_hide()) </code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
